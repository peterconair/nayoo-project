<!DOCTYPE html>
<html lang="en" data-ng-app="app">
<head>
  <meta charset="utf-8" />
  <title>Angular version | Angulr</title>
  <meta name="description" content="Angularjs, Html5, Music, Landing, 4 in 1 ui kits package" />
  <meta name="keywords" content="AngularJS, angular, bootstrap, admin, dashboard, panel, app, charts, components,flat, responsive, layout, kit, ui, route, web, app, widgets" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="stylesheet" href="libs/assets/animate.css/animate.css" type="text/css" />
  <link rel="stylesheet" href="libs/assets/font-awesome/css/font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="libs/assets/simple-line-icons/css/simple-line-icons.css" type="text/css" />
  <link rel="stylesheet" href="libs/angular/angular-material/angular-material.css" type="text/css" />
  <link rel="stylesheet" href="css/app.min.css" type="text/css" />
    
  <script src="libs/signalr/jquery.signalR-2.2.0.min.js"></script>
  <script src="libs/signalr/jquery-1.10.2.min.js"></script>
    
    
    <script src="http://192.168.1.11/NayooAPIs/signalr/hubs"></script>

    <script type="text/javascript">

        var name="Toey";
        var companyCode ="admin";
        $(function () {



            // Declare a proxy to reference the hub.
            var chatHub = $.connection.chatHub;

            //chatHub.server.connect("");


            registerClientMethods(chatHub);

            // Start Hub
            $.connection.hub.start().done(function () {

                registerEvents(chatHub)

            });

        });


        function registerEvents(chatHub) {

            $ chatHub.server.connect(name, companycode);

            });

        }

        function registerClientMethods(chatHub) {

            // Calls when user successfully logged in
            chatHub.client.onConnected = function (id, userName, companyCode, allUsers, messages) {
              
                // Add All Users
                for (i = 0; i < allUsers.length; i++) {
                    if (companyCode == allUsers[i].CompanyCode) {
                        AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName, allUsers[i].CompanyCode);
                    }
                }

                // Add Existing Messages
                for (i = 0; i < messages.length; i++) {
                    if (companyCode == allUsers[i].CompanyCode) {
                        AddMessage(messages[i].UserName, messages[i].Message);
                    }
                }


            }

            // On New User Connected
            chatHub.client.onNewUserConnected = function (id, name, companyCode) {
                var MycompanyCode = $('#hdCompanyCode').val();
                if (MycompanyCode == companyCode) {
                    AddUser(chatHub, id, name, companyCode);
                }
            }

            // On User Disconnected
            chatHub.client.onUserDisconnected = function (id, userName, companyCode) {

                var MycompanyCode = $('#hdCompanyCode').val();
                if (MycompanyCode == companyCode) {
                    $('#' + id).remove();

                    var ctrId = 'private_' + id;
                    $('#' + ctrId).remove();


                    var disc = $('<div class="disconnect">"' + userName + '" logged off.</div>');

                    $(disc).hide();
                    $('#divusers').prepend(disc);
                    $(disc).fadeIn(200).delay(2000).fadeOut(200);
                }

            }

            chatHub.client.messageReceived = function (userName, companyCode, message) {
                
                if (MycompanyCode == companyCode) {
                    alert(message);
                    AddMessage(userName, companyCode, message);
                }
            }

            chatHub.client.sendPrivateMessage = function (windowId, fromUserName, message) {

                var ctrId = 'private_' + windowId;


                if ($('#' + ctrId).length == 0) {

                    createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName);

                }

                $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + fromUserName + '</span>: ' + message + '</div>');

                // set scrollbar
                var height = $('#' + ctrId).find('#divMessage')[0].scrollHeight;
                $('#' + ctrId).find('#divMessage').scrollTop(height);

            }

        }


    </script>
    
</head>
<body ng-controller="AppCtrl" layout="row">
  <div layout="column" flex ui-view></div>
  <!-- jQuery -->
  <script src="js/app.min.js"></script>
  <!-- Lazy loading -->
</body>
</html>
